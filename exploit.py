import socket
from datetime import datetime, UTC
import argparse
import requests

HOST = "0.0.0.0"
PORT = 2398

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
sock.bind((HOST, PORT))
sock.listen(5)


parser = argparse.ArgumentParser(description="Simple TCP listener.")
parser.add_argument("--location", action="store_true", help="If passed will also log information about victim IP address")
args = parser.parse_args()

print(f"[+] Listening on {HOST}:{PORT} // Note : You can also get victim position by passing the --location CLI arg")

grabbed_ips = []

def print_ip_info(ip):
    res = requests.get(f"http://ip-api.com/json/{ip}")
    if res.status_code == 200:
        parsed_json = res.json()
        print(f"    country: {parsed_json.get('country', 'N/A')}")
        print(f"    countryCode: {parsed_json.get('countryCode', 'N/A')}")
        print(f"    region: {parsed_json.get('region', 'N/A')}")
        print(f"    regionName: {parsed_json.get('regionName', 'N/A')}")
        print(f"    city: {parsed_json.get('city', 'N/A')}")
        print(f"    zip: {parsed_json.get('zip', 'N/A')}")
        print(f"    lat: {parsed_json.get('lat', 'N/A')}")
        print(f"    lon: {parsed_json.get('lon', 'N/A')}")
        print(f"    timezone: {parsed_json.get('timezone', 'N/A')}")
        print(f"    isp: {parsed_json.get('isp', 'N/A')}")
        print(f"    org: {parsed_json.get('org', 'N/A')}")
        print(f"    as: {parsed_json.get('as', 'N/A')}")
    else:
        print("Could not retrieve information about given IP")

while True:
    conn, addr = sock.accept()
    ip, port = addr
    timestamp = datetime.now(UTC)
    
    if ip not in grabbed_ips:
        print(f"[!] Incoming connection")
        print(f"    IP        : {ip}")
        print(f"    Port      : {port}")
        print(f"    Timestamp : {timestamp} UTC\n")
        if args.location == True:
            print_ip_info(ip)
        
        grabbed_ips.append(ip)

    conn.close()